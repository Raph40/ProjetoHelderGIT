<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Entrar no Evento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
<div class="header">
    <a href="{{ url_for('index_Aluno') }}" class="logo">
        <img src="{{ url_for('static', filename='abrantes_logo.png') }}" alt="AbrantesLogo" class="logo-img" />
    </a>
    <div class="header-right">
        <a href="{{ url_for('index_Aluno') }}">InÃ­cio Aluno</a>
        <a href="{{ url_for('EventosDecorrer') }}">Eventos a Decorrer</a>
        <a href="{{ url_for('EventosFinalizados') }}">Eventos Finalizados</a>
        <a href="{{ url_for('logout') }}">Logout</a>
    </div>
</div>
<!-- Mensagem para os erros e sucessos no flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %}
{% endif %}
{% endwith %}
<!-- Mensagem para os erros e sucessos no flash -->
<div class="container my-5">
    <h1 class="mb-4">Entrar no Evento: {{ evento.Nome }}</h1>
    <!-- Formulario -->
    <form method="POST" action="/EntrarEvento/{{ evento['_id'] }}" onsubmit="return validarEntrada(this)" class="mt-4">
        <div class="mb-3">
            <label for="nifid" class="form-label">NIF</label>
            <input type="number" id="nifid" name="nif" class="form-control" placeholder="NIF">
            <div class="erro-bilhete text-danger d-block mt-1"></div>
            <button type="button" class="btn btn-secondary mt-2" onclick="reconhecerVoz(this)">ðŸŽ¤ Gravar</button>
        </div>

        <div class="mb-3">
            <label for="codigoid" class="form-label">CÃ³digo de Acesso</label>
            <input type="number" id="codigoid" name="codigo" class="form-control" placeholder="CÃ³digo de Acesso">
            <div class="erro-bilhete text-danger d-block mt-1"></div>
            <button type="button" class="btn btn-secondary mt-2" onclick="reconhecerVoz(this)">ðŸŽ¤ Gravar</button>
        </div>

        <button type="submit" class="btn btn-primary w-100">Submeter</button>
    </form>
    <!-- Formulario -->
</div>

<script>
    //FunÃ§Ã£o para validar os campos do formulÃ¡rio de entrada NIF e cÃ³digo
    function validarEntrada(form) {
        //Limpa mensagens de erro anteriores
        const erros = form.querySelectorAll('.erro-bilhete');
        erros.forEach((e) => {
            //Limpa o texto de erro
            e.innerText = '';
            //Esconde o elemento de erro
            e.style.display = 'none';
        });

        //Flag para controlar se o formulÃ¡rio Ã© vÃ¡lido
        let valido = true;

        //ObtÃ©m e limpa os valores dos campos NIF e cÃ³digo
        const nif = form.nif?.value.trim();
        const codigo = form.codigo?.value.trim();

        //ValidaÃ§Ã£o do NIF: deve ter 9 dÃ­gitos numÃ©ricos
        if (nif === '' || isNaN(nif) || nif.length !== 9) {
            mostrarErro(form.nif, 'Informe um NIF vÃ¡lido com 9 dÃ­gitos.');
            valido = false;
        }

        //ValidaÃ§Ã£o do cÃ³digo de acesso: deve ter 4 dÃ­gitos numÃ©ricos
        if (codigo === '' || isNaN(codigo) || codigo.length !== 4) {
            mostrarErro(form.codigo, 'Informe um cÃ³digo de acesso vÃ¡lido.');
            valido = false;
        }

        //Retorna true se todos os campos forem vÃ¡lidos
        return valido;
    }

    //Exibe uma mensagem de erro logo apÃ³s o campo invÃ¡lido
    function mostrarErro(inputElem, mensagem) {
        //Assume que o span de erro estÃ¡ logo apÃ³s o input
        const erroDiv = inputElem.nextElementSibling;
        erroDiv.innerText = mensagem;
        //Torna visÃ­vel
        erroDiv.style.display = 'block';
    }

    //FunÃ§Ã£o para reconhecimento de voz e preenchimento automÃ¡tico do campo
    function reconhecerVoz(botao) {
        //Cria uma instÃ¢ncia da API de reconhecimento de voz
        const reconhecimento = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        //Define o idioma como portuguÃªs de Portugal
        reconhecimento.lang = 'pt-PT';
        //Resultados apenas quando finalizados
        reconhecimento.interimResults = false;
        //Apenas a melhor alternativa
        reconhecimento.maxAlternatives = 1;

        //Localiza o campo de input relacionado ao botÃ£o clicado
        const input = botao.parentElement.querySelector('input');
        if (!input) {
            console.error("Input correspondente nÃ£o encontrado.");
            return;
        }

        //Inicia o reconhecimento de voz
        reconhecimento.start();

        //Quando o reconhecimento obtÃ©m um resultado
        reconhecimento.onresult = (event) => {
            // Extrai o texto reconhecido
            const texto = event.results[0][0].transcript;
            // Insere no campo, removendo caracteres nÃ£o numÃ©ricos
            input.value = texto.replace(/\D/g, '');
        };

        //Em caso de erro no reconhecimento
        reconhecimento.onerror = (event) => {
            console.error("Erro de reconhecimento:", event.error);
        };
    }

    //FunÃ§Ã£o de desaparecimento gradual para elementos como alertas
    function fadeOutEffect(element) {
        //ComeÃ§a com opacidade total
        let opacity = 1;

        //Intervalo de reduÃ§Ã£o gradual de opacidade
        const timer = setInterval(() => {
            if (opacity <= 0.05) {
                //Para o temporizador
                clearInterval(timer);
                //Remove o elemento da pÃ¡gina (DOM)
                element.remove();
            }
            //Aplica a nova opacidade
            element.style.opacity = opacity;
            //Reduz opacidade
            opacity -= 0.05;
            //A cada 50ms
        }, 50);
    }

    //Quando a pÃ¡gina Ã© carregada, desaparece automaticamente os alertas apÃ³s 3 segundos
    window.onload = function() {
        //Seleciona todos os alertas
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                //Aplica fade out apÃ³s 3 segundos
                fadeOutEffect(alert);
            }, 3000);
        });
    };
</script>
</body>
</html>
