<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Descarregar PDFs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .qr-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      z-index: 1050;
      display: none;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
<div class="header">
  <a href="{{ url_for('index') }}" class="logo">
    <img src="{{ url_for('static', filename='abrantes_logo.png') }}" alt="AbrantesLogo" class="logo-img" />
  </a>
  <div class="header-right">
    <a href="{{ url_for('index_Aluno') }}">Início Aluno</a>
    <a href="{{ url_for('EventosDecorrer') }}">Eventos a Decorrer</a>
    <a href="{{ url_for('EventosFinalizados') }}">Eventos Finalizados</a>
    <a href="{{ url_for('logout') }}">Logout</a>
  </div>
</div>

<!-- Mensagem flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="main-content container text-center mt-5">
  <h1 class="mb-5">Descarregar Cetificado de Participação deste Evento: {{ evento_inf.get('Nome') }}</h1>

  <!-- PDF Anonimizado -->
  <div class="mb-5">
    <h3>Descarregar Certificado em PDF</h3>
    <div class="d-flex justify-content-center gap-3 mt-3">
      <a href="{{ url_for('downloadCertificado', _id=evento_inf['_id']) }}" class="btn btn-secondary btn-lg">
        Descarregar PDF
      </a>
      <button type="button" class="btn btn-info btn-lg" onclick="mostrarQRCode('{{ url_for('downloadPDFQRCcode', _id=evento_inf['_id']) }}')">
        Mostrar QR Code
      </button>
    </div>
  </div>

  <!-- PDF gerado por idioma -->
  <div>
    <h3>Descarregar Certificado em PDF por Idioma</h3>
    <form method="POST" class="mt-3" action="{{ url_for('downloadPDFidioma', _id=evento_inf['_id']) }}">
      <div class="mb-3 w-50 mx-auto">
        <select class="form-select" name="idioma" required>
          <option value="pt">Português</option>
          <option value="en">Inglês</option>
          <option value="it">Italiano</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary btn-lg">Descarregar PDF´s</button>
    </form>
  </div>
</div>

<!-- Popup do QR Code -->
<div id="qrPopup" class="qr-popup">
  <div class="bg-white p-4 rounded text-center">
    <h4>QR Code para Download</h4>
    <img id="qrCodeImg" src="" alt="QR Code" class="img-fluid my-3" style="max-width: 300px;">
    <br>
    <button class="btn btn-danger" onclick="fecharQRCode()">Fechar</button>
  </div>
</div>

<!-- Scripts -->
<script>
  // Função para decodificar o Base64 e fazer download
  function downloadFromBase64(base64Data, filename) {
    const byteCharacters = atob(base64Data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], {type: 'application/pdf'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Função para ler o QR Code (quando escaneado)
  function handleQRCodeScan(decodedText) {
    try {
      const data = JSON.parse(decodedText);
      if (data.pdf_base64) {
        downloadFromBase64(data.pdf_base64, data.filename);
      } else {
        alert("QR Code não contém dados de PDF válidos.");
      }
    } catch (e) {
      alert("Erro ao processar QR Code: " + e.message);
    }
  }

  // Exemplo de como integrar com um leitor de QR Code
  // Você pode usar bibliotecas como https://github.com/mebjas/html5-qrcode
  function setupQRScanner() {
    const html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              html5QrCode.stop();
              handleQRCodeScan(decodedText);
            },
            (errorMessage) => console.error(errorMessage)
    );
  }
</script>
</body>
</html>
