<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Descarregar PDFs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .qr-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      z-index: 1050;
      display: none;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
<div class="header">
  <a href="{{ url_for('index_Aluno') }}" class="logo">
    <img src="{{ url_for('static', filename='abrantes_logo.png') }}" alt="AbrantesLogo" class="logo-img" />
  </a>
  <div class="header-right">
    <a href="{{ url_for('index_Aluno') }}">Início Aluno</a>
    <a href="{{ url_for('EventosDecorrer') }}">Eventos a Decorrer</a>
    <a href="{{ url_for('EventosFinalizados') }}">Eventos Finalizados</a>
    <a href="{{ url_for('logout') }}">Logout</a>
  </div>
</div>

<!-- Mensagem flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="main-content container text-center mt-5">
  <h1 class="mb-5">Descarregar Cetificado de Participação deste Evento: {{ evento_inf.get('Nome') }}</h1>

  <!-- PDF Anonimizado -->
  <div class="mb-5">
    <h3>Descarregar Certificado em PDF</h3>
    <div class="d-flex justify-content-center gap-3 mt-3">
      <a href="{{ url_for('downloadCertificado', _id=evento_inf['_id']) }}" class="btn btn-secondary btn-lg">
        Descarregar PDF
      </a>
      <button type="button" class="btn btn-info btn-lg" onclick="mostrarQRCode('{{ url_for('downloadPDFQRCcode', _id=evento_inf['_id']) }}')">
        Mostrar QR Code
      </button>
    </div>
  </div>

  <!-- PDF gerado por idioma -->
  <div>
    <h3>Descarregar Certificado em PDF por Idioma</h3>
    <form method="POST" class="mt-3" action="{{ url_for('downloadPDFidioma', _id=evento_inf['_id']) }}">
      <div class="mb-3 w-50 mx-auto">
        <select class="form-select" name="idioma" required>
          <option value="pt">Português</option>
          <option value="en">Inglês</option>
          <option value="it">Italiano</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary btn-lg">Descarregar PDF´s</button>
    </form>
  </div>
</div>

<!-- Popup do QR Code -->
<div id="qrPopup" class="qr-popup">
  <div class="bg-white p-4 rounded text-center">
    <h4>QR Code para Download</h4>
    <img id="qrCodeImg" src="" alt="QR Code" class="img-fluid my-3" style="max-width: 300px;">
    <br>
    <button class="btn btn-danger" onclick="fecharQRCode()">Fechar</button>
  </div>
</div>

<!-- Scripts -->
<script>
  // Função para mostrar o QR Code
  function mostrarQRCode(qrCodeUrl) {
    // Mostrar loading no popup
    document.getElementById('qrCodeImg').src = "";
    document.getElementById('qrPopup').style.display = 'flex';

    fetch(qrCodeUrl)
            .then(response => {
              if (!response.ok) {
                throw new Error('Erro na rede');
              }
              return response.json();
            })
            .then(data => {
              if (data.status === "success") {
                // Criar imagem do QR Code a partir dos dados base64
                document.getElementById('qrCodeImg').src = `data:image/png;base64,${data.qr_code}`;
              } else {
                throw new Error(data.message || "Erro ao gerar QR Code");
              }
            })
            .catch(error => {
              console.error('Erro:', error);
              alert('Erro ao carregar QR Code: ' + error.message);
              document.getElementById('qrPopup').style.display = 'none';
            });
  }

  // Função para fechar o popup
  function fecharQRCode() {
    document.getElementById('qrPopup').style.display = 'none';
  }

  // Função para lidar com o escaneamento do QR Code
  function handleQRCodeScan(decodedText) {
    try {
      const data = JSON.parse(decodedText);
      if (data.pdf_base64) {
        downloadFromBase64(data.pdf_base64, data.filename);
      }
    } catch (e) {
      alert("Erro ao processar QR Code: " + e.message);
    }
  }

  // Função para fazer download a partir de base64
  function downloadFromBase64(base64Data, filename) {
    const link = document.createElement('a');
    link.href = `data:application/pdf;base64,${base64Data}`;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    fecharQRCode();
  }
</script>
</body>
</html>
